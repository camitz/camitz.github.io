

<!doctype html>
<html lang="sv" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>EC2 Spot Instance Termination Notification to SNS - Cozmiq Debris</title>







<meta property="og:locale" content="sv-SE">
<meta property="og:site_name" content="Cozmiq Debris">
<meta property="og:title" content="EC2 Spot Instance Termination Notification to SNS">


  <link rel="canonical" href="http://blog.simpletask.se/EC2SpotStop2SNS">
  <meta property="og:url" content="http://blog.simpletask.se/EC2SpotStop2SNS">



  <meta property="og:description" content="The AWS team yesterday announced that it would publish notifications of imminent termination of spot instances in the form of a date string accesible via the AWS instance metadata service, the date being the time of expected termination. Termination of spot is usually due to the spot price exceeding the configured maximum price.">



  <meta name="twitter:site" content="@martincamitz">
  <meta name="twitter:title" content="EC2 Spot Instance Termination Notification to SNS">
  <meta name="twitter:description" content="The AWS team yesterday announced that it would publish notifications of imminent termination of spot instances in the form of a date string accesible via the AWS instance metadata service, the date being the time of expected termination. Termination of spot is usually due to the spot price exceeding the configured maximum price.">
  <meta name="twitter:url" content="http://blog.simpletask.se/EC2SpotStop2SNS">

  
    <meta name="twitter:card" content="summary">
    
  

  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2015-01-05T16:00:00+00:00">
  
    <link rel="next" href="http://blog.simpletask.se/EC2SpotStop2SNS" title="EC2 Spot Instance Termination Notification to SNS">
  
  
    <link rel="prev" href="http://blog.simpletask.se/buffering-aggregating-cloudwatch-appender" title="Introducing the Buffering and Aggregeting CloudWatch Appender">
  





  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "person",
      "name" : "Martin Camitz",
      "url" : "http://blog.simpletask.se",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->

<link href="http://blog.simpletask.se/feed.xml" type="application/atom+xml" rel="alternate" title="Cozmiq Debris Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://blog.simpletask.se/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="http://blog.simpletask.se/">Cozmiq Debris</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    





<div id="main" role="main">
  


  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="http://blog.simpletask.se/images/bio-photo.jpg" class="author__avatar" alt="Martin Camitz">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Martin Camitz</h3>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li><i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> Stockholm</li>
      
      
      
        <li><a href="mailto:martin.camitz@simpletask.se"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> </a></li>
      
      
      
        <li><a href="https://twitter.com/martin.camitz"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
      
      
      
      
      
      
      
      
      
      
        <li><a href="https://www.stackoverflow.com/users/http://stackoverflow.com/users/168390/martin"><i class="fa fa-fw fa-stack-overflow" aria-hidden="true"></i> Stackoverflow</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="EC2 Spot Instance Termination Notification to SNS">
    <meta itemprop="description" content="The AWS team yesterday announced that it would publish notifications of imminent termination of spot instances in the form of a date string accesible via the AWS instance metadata service, the date being the time of expected termination. Termination of spot is usually due to the spot price exceeding the configured maximum price.">
    <meta itemprop="datePublished" content="January 05, 2015">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">EC2 Spot Instance Termination Notification to SNS
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  2 
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <p>The AWS team yesterday <a href="https://aws.amazon.com/blogs/aws/new-ec2-spot-instance-termination-notices/?sc_ichannel=em&amp;sc_icountry=global&amp;sc_icampaigntype=launch&amp;sc_icampaign=em_130420040&amp;sc_idetail=em_66267057&amp;ref_=pe_395030_130420040_8">announced</a> that it would publish notifications of imminent termination of spot instances in the form of a date string accesible via the AWS <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html">instance metadata service</a>, the date being the time of expected termination. Termination of spot is usually due to the spot price exceeding the configured maximum price.</p>

<p>So now the instance can find out that it is being terminated and can take approprate action and that’s really great. But I want to know aswell!</p>

<p>And Amazon has really great infrastructure for notifications called <a href="http://aws.amazon.com/sns/">SNS</a>. Service can subsribe to topics and it can send emails and more. Connect the two and I can find out when my spots are terminated.</p>

<p>That’s just me, for my personal satisfaction of knowing. But what other people will find even more useful is of course other applications subscribing to these notices, other spot instances for example. Maybe they need to adjust their games in the event of fellow instances being dropped. That reduces the need for a central controller and instances can become more autonomical.</p>

<h2 id="introducing-ec2spotstop2snshttpsgithubcomcamitzec2spotstop2sns">Introducing <a href="https://github.com/camitz/EC2SpotStop2SNS">EC2SpotStop2SNS</a></h2>

<p>Nothing fancy. You can run it from the command line or install it as a service. It even has an installer.</p>

<p>As per the recommendations of Jeff Barr, it will poll the metadata service every 5 seconds. If the termination notice appears it immediately publishes a message to SNS.</p>

<p>If there isn’t a topic on SNS it will create one when you run it the first time. Goto AWS management console and configure the topic to throw you an email or text once something is published.</p>

<p>That would have been the end if there wasn’t a second need that I’ve come across before.</p>

<h2 id="introducing-mockec2instancemetadatahttpsgithubcomcamitzmockec2instancemetadata">Introducing <a href="https://github.com/camitz/MockEC2InstanceMetaData">MockEC2InstanceMetaData</a></h2>

<p>How can I debug this locally? Already when I was working an the early versions of log4net <a href="https://www.google.se/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=2&amp;cad=rja&amp;uact=8&amp;ved=0CCwQFjAB&amp;url=http%3A%2F%2Fblog.simpletask.se%2Fpost%2Fbuffering-aggregating-cloudwatch-appender&amp;ei=gmqtVI_AMeSZygPXn4LwBA&amp;usg=AFQjCNHtqHMn2vWFqauv_xnzxoRC8pyJDw&amp;sig2=r_NhyK-8uIvHGe_yLVNX3w&amp;bvm=bv.83134100,d.bGQ">CloudWatchAppender</a> I realized this need. I just winged it back then.</p>

<p>So this is a bit of ad hoc programming. It uses the an Owin stack to listen in on 127.0.0.1:9000 (the port is configurable). Not useful unless you redirect traffic from 169.254.169.254. I think I could figure out how to listen to 169.254.169.254 but decided to save the hassle on something <a href="http://www.telerik.com/download/fiddler">Fiddler</a> does so well. It works like your windows hosts file except allows for ports as well.</p>

<p>Then the app will answer all your calls to it producing something hopefully similar to what you get from the real metadata service. It worked splendidly for debugging EC2SpotStop2SNS, at the very least.</p>

<p>The data is completely configurable via a json file and what’s more, it reads the file everytime you want a response, so you don’t have to restart the application when you make a change.</p>

<h2 id="whats-next">What’s next?</h2>

<p>Obviously I couldn’t be bothered to configure my json with all the data from a particular instance metadata service. Now all I need is an app the does that for me. Shouldn’t be that hard to do. You’re welcome to help me out on that one.</p>

        
      </section>

      <footer class="page__meta">
        
        


  




  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i>  </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://blog.simpletask.se/tags/#amazon" class="page__taxonomy-item" rel="tag">amazon</a><span class="sep">, </span>
    
      
      
      <a href="http://blog.simpletask.se/tags/#aws" class="page__taxonomy-item" rel="tag">AWS</a><span class="sep">, </span>
    
      
      
      <a href="http://blog.simpletask.se/tags/#instance-meta-data" class="page__taxonomy-item" rel="tag">instance meta data</a><span class="sep">, </span>
    
      
      
      <a href="http://blog.simpletask.se/tags/#sns" class="page__taxonomy-item" rel="tag">SNS</a><span class="sep">, </span>
    
      
      
      <a href="http://blog.simpletask.se/tags/#spot-instance" class="page__taxonomy-item" rel="tag">spot instance</a><span class="sep">, </span>
    
      
      
      <a href="http://blog.simpletask.se/tags/#termination" class="page__taxonomy-item" rel="tag">termination</a><span class="sep">, </span>
    
      
      
      <a href="http://blog.simpletask.se/tags/#windows" class="page__taxonomy-item" rel="tag">windows</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> </strong> <time datetime="2015-01-05T16:00:00+00:00">January 05, 2015</time></p>
        
      </footer>

      

<section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=http://blog.simpletask.se/EC2SpotStop2SNS" class="btn btn--twitter" title=" Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.simpletask.se/EC2SpotStop2SNS" class="btn btn--facebook" title=" Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http://blog.simpletask.se/EC2SpotStop2SNS" class="btn btn--google-plus" title=" Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://blog.simpletask.se/EC2SpotStop2SNS" class="btn btn--linkedin" title=" LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      


  <nav class="pagination">
    
      <a href="http://blog.simpletask.se/buffering-aggregating-cloudwatch-appender" class="pagination--pager" title="Introducing the Buffering and Aggregeting CloudWatch Appender
"></a>
    
    
      <a href="http://blog.simpletask.se/EC2SpotStop2SNS" class="pagination--pager" title="EC2 Spot Instance Termination Notification to SNS
"></a>
    
  </nav>

    </div>

    
      

<div class="page__comments">
  <h4 class="page__comments-title"></h4>
  
    <section id="disqus_thread"></section>
  
</div>
    
  </article>

  
  
    <div class="page__related">
      
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  
    <a href="http://blog.simpletask.se/EC2SpotStop2SNS">
  
    <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
      
      <h2 class="archive__item-title" itemprop="headline">EC2 Spot Instance Termination Notification to SNS
</h2>
      
        <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  2 
</p>
      
      <p class="archive__item-excerpt" itemprop="description">The AWS team yesterday announced that it would publish notifications of imminent termination of spot instances in the form of a date string accesible via the...</p>
    </article>
  </a>
</div>
        
          



<div class="grid__item">
  
    <a href="http://blog.simpletask.se/buffering-aggregating-cloudwatch-appender">
  
    <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
      
      <h2 class="archive__item-title" itemprop="headline">Introducing the Buffering and Aggregeting CloudWatch Appender
</h2>
      
        <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  6 
</p>
      
      <p class="archive__item-excerpt" itemprop="description">The CloudWatch Appender for log4net is an appender that targets AWS CloudWatch. So if you have any kind of service on the Amazon cloud you can easily forward...</p>
    </article>
  </a>
</div>
        
          



<div class="grid__item">
  
    <a href="http://blog.simpletask.se/buffering-aggregating-cloudwatch-appender">
  
    <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
      
      <h2 class="archive__item-title" itemprop="headline">Introducing the Buffering and Aggregeting CloudWatch Appender
</h2>
      
        <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  6 
</p>
      
      <p class="archive__item-excerpt" itemprop="description">The CloudWatch Appender for log4net is an appender that targets AWS CloudWatch. So if you have any kind of service on the Amazon cloud you can easily forward...</p>
    </article>
  </a>
</div>
        
          



<div class="grid__item">
  
    <a href="http://blog.simpletask.se/welcome to russia dear crimeans">
  
    <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
      
      <h2 class="archive__item-title" itemprop="headline">Welcome to Russia, dear Crimeans!
</h2>
      
        <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  6 
</p>
      
      <p class="archive__item-excerpt" itemprop="description">by Arkady Babtjenko

</p>
    </article>
  </a>
</div>
        
      </div>
    </div>
  
</div>

    <div class="page__footer">
      <footer>
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
    
      <li><a href="https://twitter.com/martincamitz"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
    
    <li><a href="http://blog.simpletask.se/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> </a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2016 Martin Camitz.  <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    <script src="http://blog.simpletask.se/assets/js/main.min.js"></script>




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34001047-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'camitz';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






    <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

  </body>
</html>

